workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "stable" || $CI_COMMIT_BRANCH == "develop"'
      changes:
        - version.yaml
    - when: never

default:
  tags: [win]

stages:
  - version
  - deploy

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"

  SOLUTION: "LawyerAssistant.sln"
  PUBLISH_ROOT: "publish"

  API_CSPROJ: "LawyerAssistant.PanelAPI/LawyerAssistant.PanelAPI.csproj"


Tag-Check:
  stage: version
  script:
    - echo "Adding Tag For Release..."
    - $APP_VERSION=$(yq e '.version' version.yaml);
    - if ($(git tag -l "$APP_VERSION")) {
      echo "Tag $APP_VERSION Already Exists. Stopping The Pipeline...";
      exit 1;
      } else {
      echo "Tag $APP_VERSION does not exist. Creating and pushing tag...";
      git tag -a $APP_VERSION -m "Release version $APP_VERSION";
      git push https://root:$CI_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git --tags;
      }

.deploy_job_template: &deploy_job_template
  tags: [win]
  script:
    - dotnet publish "$PROJECT" -c Release -o "$OUTPUT"

    - |
      powershell -NoProfile -ExecutionPolicy Bypass -Command {
      
          $branch = $Env:CI_COMMIT_BRANCH
          $project = $Env:PROJECT

          $projectFileName = Split-Path $project -Leaf

          $appConfigContent = switch -Wildcard ($projectFileName) {
              "*LawyerAssistant.PanelAPI.csproj*" { if ($branch -eq "stable") { $env:APP_SETTING_PROD } else { $env:APP_SETTING_DEV } }
               default   { "" }
          }

          $appConfigDest = Join-Path $Env:OUTPUT "appsettings.json"

          if (-not [string]::IsNullOrWhiteSpace($appConfigContent)) {
              # ŸÜŸàÿ¥ÿ™ŸÜ ŸÖÿ≠ÿ™Ÿàÿß€å JSON ÿØÿ± ŸÅÿß€åŸÑ
              $appConfigContent | Out-File -FilePath $appConfigDest -Encoding utf8
              Write-Host "‚úÖ appconfig.json created at $appConfigDest"
          } else {
              Write-Host "‚ö†Ô∏è appconfig content is empty. Skipping..."
          }

          $site = if ($branch -eq "stable") { $Env:WEB_SITE_PROD } else { $Env:WEB_SITE_DEV }

          if ([string]::IsNullOrWhiteSpace($site)) {
            Write-Error "‚ùå IIS site name is not set (WEB_SITE_DEV or WEB_SITE_PROD)."
            exit 1
          }

          $sourcePath = Resolve-Path $Env:OUTPUT | Select-Object -ExpandProperty Path
          if (-not (Test-Path $sourcePath)) {
            Write-Error "‚ùå Publish folder not found: $sourcePath"
            exit 1
          }

          $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
          if (-not (Test-Path $msdeploy)) {
            Write-Error "‚ùå msdeploy.exe not found: $msdeploy"
            exit 1
          }

          Write-Host "üöÄ Starting deployment to $site"

          & $msdeploy `
            -verb:sync `
            -source:contentPath="$sourcePath" `
            -dest:"contentPath=$site,computerName=https://$Env:WEBDEPLOY_SERVER/msdeploy.axd?site=$site,userName=$Env:WEBDEPLOY_USERNAME,password=$Env:WEBDEPLOY_PASSWORD,authType=Basic" `
            -enableRule:AppOffline `
            -allowUntrusted

          Write-Host "‚úÖ Deployment to $site completed successfully."


        if ($branch -eq "stable") {
          # 1. Read version
          $appVersion   = (yq e '.version' version.yaml)
          $uploadDir    = "$Env:CI_PROJECT_PATH/$appVersion"
          $ftpRoot      = "$Env:RELEASE_FTP_ADDRESS"
          $downloadRoot = "$Env:RELEASE_ADDRESS"
          $publishRoot  = "$PUBLISH_ROOT"
      
          # Debug: print all variables (including if they are empty)
          Write-Host "==================== VARIABLES ===================="
          Write-Host "App Version:     [$appVersion]"
          Write-Host "Upload Directory:[$uploadDir]"
          Write-Host "FTP Root:        [$ftpRoot]"
          Write-Host "Download Root:   [$downloadRoot]"
          Write-Host "Publish Root:    [$publishRoot]"
          Write-Host "===================================================="
      
          if (-not $appVersion -or -not $ftpRoot -or -not $downloadRoot -or -not $publishRoot) {
              Write-Error "‚ùå One or more variables are empty. Check environment variables and version.yaml"
              exit 1
          }
      
          # 2. Compress PUBLISH_ROOT folder
          $zipName = "${appVersion}.zip"
          $zipPath = Join-Path $publishRoot $zipName
      
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
      
          Write-Host "üóú Compressing '$publishRoot' ‚Üí $zipName..."
          Compress-Archive -Path (Join-Path $publishRoot '*') -DestinationPath $zipPath -Force
          Write-Host "‚úÖ Archive created: $zipPath"
      
          # 3. Create FTP directories for upload
          foreach ($part in $uploadDir.Split('/')) {
              $ftpRoot = "$ftpRoot/$part"
              try {
                  Write-Host "üìÅ Creating FTP directory: $ftpRoot"
                  $req = [System.Net.FtpWebRequest]::Create($ftpRoot)
                  $req.Credentials = New-Object System.Net.NetworkCredential($Env:WEBDEPLOY_USERNAME, $Env:WEBDEPLOY_PASSWORD)
                  $req.Method     = [System.Net.WebRequestMethods+Ftp]::MakeDirectory
                  $req.UseBinary  = $true
                  $req.UsePassive = $true
                  $req.EnableSsl  = $false
                  $resp = $req.GetResponse(); $resp.Close()
                  Write-Host "‚úÖ Created: $ftpRoot"
              } catch {
                  if ($_.Exception.Message -like '*550*') { Write-Host "‚Ñπ Already exists: $ftpRoot" }
                  else { throw }
              }
          }
      
          # 4. Upload ZIP to FTP
          $ftpFileUri = "$ftpRoot/$zipName"
          Write-Host "üì§ Uploading archive ‚Üí $downloadRoot/$zipName"
      
          $ftp = [System.Net.FtpWebRequest]::Create($ftpFileUri)
          $ftp.Credentials = New-Object System.Net.NetworkCredential($Env:WEBDEPLOY_USERNAME, $Env:WEBDEPLOY_PASSWORD)
          $ftp.Method     = [System.Net.WebRequestMethods+Ftp]::UploadFile
          $ftp.UseBinary  = $true
          $ftp.UsePassive = $true
          $ftp.EnableSsl  = $false
      
          $bytes  = [System.IO.File]::ReadAllBytes($zipPath)
          $stream = $ftp.GetRequestStream()
          $stream.Write($bytes, 0, $bytes.Length)
          $stream.Close()
          $resp = $ftp.GetResponse()
          Write-Host "‚Üí $($resp.StatusDescription.Trim())"
          $resp.Close()
    
          Write-Host "‚úÖ Backup ZIP uploaded. Download URL: $downloadRoot/$zipName"
        } else {
            Write-Host "‚ö†Ô∏è Branch is NOT stable. Skipping backup upload."
        }
      }


deploy-api:
  stage: deploy
  variables:
    PROJECT: "$API_CSPROJ"
    OUTPUT: "$PUBLISH_ROOT/api"
    WEB_SITE_DEV: "api.dev.dadnegaar.ir"
    WEB_SITE_PROD: "api.dadnegaar.ir"
  <<: *deploy_job_template